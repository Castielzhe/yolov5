import torch
import yaml

from models.yolo import Model
from utils.loss import ComputeLoss


def t0(hyp):
    cfg = '../models/yolov5s_copy.yaml'
    model = Model(
        cfg,  # 模型结构配置文件路径信息
        ch=3,  # 输入通道数量
        nc=None,  # 给定类别数目
        anchors=None  # 给定anchor先验框大小
    )
    model.hyp = hyp

    imgs = torch.rand(4, 3, 640, 640)
    targets = torch.tensor([[0.00000e+00, 1.60000e+01, 9.10630e-02, 4.77590e-01, 5.97623e-02, 8.41355e-02],
                            [0.00000e+00, 0.00000e+00, 7.72943e-02, 3.10865e-01, 1.50201e-02, 4.79715e-02],
                            [0.00000e+00, 0.00000e+00, 1.00905e-01, 2.99971e-01, 1.10490e-02, 2.11439e-02],
                            [0.00000e+00, 0.00000e+00, 1.25987e-01, 3.09344e-01, 1.28103e-02, 4.24674e-02],
                            [0.00000e+00, 0.00000e+00, 2.18485e-01, 3.13038e-01, 2.58163e-02, 3.41662e-02],
                            [0.00000e+00, 0.00000e+00, 6.42152e-02, 3.14049e-01, 6.06678e-03, 3.82270e-02],
                            [0.00000e+00, 0.00000e+00, 6.49897e-02, 3.04472e-01, 7.61582e-03, 1.97740e-02],
                            [0.00000e+00, 4.00000e+00, 6.20199e-01, 3.73746e-01, 4.76215e-01, 2.59321e-01],
                            [0.00000e+00, 2.50000e+01, 1.96412e-01, 7.73960e-01, 2.70460e-01, 3.50917e-01],
                            [0.00000e+00, 0.00000e+00, 2.21727e-01, 8.29123e-01, 2.53279e-01, 2.77333e-01],
                            [0.00000e+00, 4.00000e+00, 6.20199e-01, 7.20301e-01, 4.76215e-01, 2.59321e-01],
                            [1.00000e+00, 5.80000e+01, 1.21253e-01, 5.20551e-01, 2.42505e-01, 3.79661e-01],
                            [1.00000e+00, 7.50000e+01, 8.85836e-02, 5.91249e-01, 1.77167e-01, 2.28708e-01],
                            [1.00000e+00, 5.80000e+01, 8.42897e-01, 5.20551e-01, 2.98556e-01, 3.79661e-01],
                            [1.00000e+00, 7.50000e+01, 8.29380e-01, 5.91249e-01, 1.94914e-01, 2.28708e-01],
                            [1.00000e+00, 5.80000e+01, 1.21253e-01, 9.16031e-01, 2.42505e-01, 1.67936e-01],
                            [1.00000e+00, 2.20000e+01, 7.13198e-01, 9.09612e-01, 5.16839e-01, 1.80774e-01],
                            [2.00000e+00, 2.30000e+01, 4.14279e-01, 2.51418e-01, 2.32240e-01, 3.84408e-01],
                            [2.00000e+00, 2.30000e+01, 5.05836e-01, 2.56041e-01, 1.87597e-01, 3.93655e-01],
                            [2.00000e+00, 2.50000e+01, 4.99702e-01, 6.66000e-01, 3.67690e-01, 3.45733e-01],
                            [2.00000e+00, 0.00000e+00, 4.24148e-01, 7.70592e-01, 2.49537e-01, 3.73723e-01],
                            [2.00000e+00, 4.50000e+01, 1.48128e-01, 7.18473e-01, 2.96253e-01, 2.29637e-01],
                            [2.00000e+00, 4.50000e+01, 2.33436e-02, 5.48189e-01, 4.66841e-02, 1.83716e-01],
                            [2.00000e+00, 5.00000e+01, 4.83004e-02, 7.35505e-01, 9.65978e-02, 1.96892e-01],
                            [2.00000e+00, 4.50000e+01, 1.48562e-01, 6.14404e-01, 2.97121e-01, 3.01363e-01],
                            [2.00000e+00, 4.90000e+01, 2.32744e-03, 4.83417e-01, 4.65183e-03, 5.70959e-02],
                            [3.00000e+00, 5.80000e+01, 7.63193e-01, 1.93540e-01, 4.73615e-01, 3.87079e-01],
                            [3.00000e+00, 7.50000e+01, 7.88919e-01, 1.94958e-01, 3.14331e-01, 3.68829e-01],
                            [3.00000e+00, 2.20000e+01, 7.79769e-01, 7.81302e-01, 4.40462e-01, 4.37392e-01]])

    compute_loss = ComputeLoss(model)  # init loss class 创建计算损失的对象
    pred = model(imgs)  # forward 前向guoc list[小 中 大] [N,A,H,W,C] 默认A=3, c=85
    loss, loss_items = compute_loss(pred, targets)  # loss scaled by batch_size 计算损失
    print(loss)
    print(loss_items)


def run():
    hyp = r'../data/hyps/hyp.scratch-low.yaml'
    with open(hyp, errors='ignore') as f:
        hyp = yaml.safe_load(f)  # load hyps dict

    t0(hyp)


if __name__ == '__main__':
    run()